<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Навигатор с камерами</title>
  <script src="config.js"></script>
  <script>
    const yandexApiUrl = `https://api-maps.yandex.ru/2.1/?apikey=${CONFIG.YANDEX_MAPS_API_KEY}&lang=ru_RU`;
    document.write(`<script src="${yandexApiUrl}"><\/script>`);
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
    #map { width: 100%; height: 100vh; }
    #button-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="button-container">
    <button onclick="recenterMap()">Вы</button>
  </div>
  <script>
    let map, userPlacemark, followUser = true;
    ymaps.ready(init);
    
    function init() {
      map = new ymaps.Map("map", {
        center: [56.8519, 60.6122],
        zoom: 14,
        controls: []
      });
      
      // Получаем координаты пользователя и центрируем карту
      navigator.geolocation.watchPosition(position => {
        const { latitude, longitude } = position.coords;
        if (!userPlacemark) {
          userPlacemark = new ymaps.Placemark([latitude, longitude], {}, { preset: 'islands#blueCircleDotIcon' });
          map.geoObjects.add(userPlacemark);
        } else {
          userPlacemark.geometry.setCoordinates([latitude, longitude]);
        }
        if (followUser) {
          map.setCenter([latitude, longitude]);
        }
      }, error => console.error('Ошибка геолокации:', error), { enableHighAccuracy: true });
      
      // Отключаем автоцентрирование при движении карты вручную
      map.events.add('actionbegin', () => followUser = false);
      
      // Загружаем камеры
      fetch('camera_coordinates.json')
        .then(response => response.json())
        .then(cameras => {
          cameras.forEach(camera => {
            let coords = camera.geometry.coordinates;
            let props = camera.properties;
            let placemark = new ymaps.Placemark(coords, {
              hintContent: props.hintContent,
              balloonContentBody: props.balloonContentBody
            }, {
              preset: 'islands#redIcon'
            });
            map.geoObjects.add(placemark);
          });
        })
        .catch(error => console.error('Ошибка загрузки камер:', error));
    }
    
    // Функция возвращения к пользователю
    function recenterMap() {
      followUser = true;
      if (userPlacemark) {
        map.setCenter(userPlacemark.geometry.getCoordinates());
      }
    }
  </script>
</body>
</html>
